#!/bin/sh

set -e

echo "üîç Running pre-commit checks on staged files... üîç"

# Load NVM if available (useful for managing Node.js versions)
export NVM_DIR="$HOME/.nvm"
[ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"

# Ensure `pnpm` is available
echo "Checking if pnpm is available..."
if ! command -v pnpm >/dev/null 2>&1; then
    echo "‚ùå pnpm not found! Please ensure pnpm is installed and available in PATH."
    exit 1
fi

# Get staged files (added/copied/modified/renamed)
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACMR)

if [ -z "$STAGED_FILES" ]; then
    echo "No staged files to check."
    exit 0
fi

# Only lint staged app source files
ESLINT_FILES=$(echo "$STAGED_FILES" | grep -E '^app/.*\.(ts|tsx|js|jsx)$' || true)

if [ -n "$ESLINT_FILES" ]; then
    echo "Running ESLint on staged app files..."
    echo "$ESLINT_FILES" | xargs pnpm exec eslint --cache --cache-location ./node_modules/.cache/eslint --fix
    echo "$ESLINT_FILES" | xargs git add
fi

# Format staged text files
PRETTIER_FILES=$(echo "$STAGED_FILES" | grep -E '\.(ts|tsx|js|jsx|json|css|scss|md|yml|yaml)$' || true)

if [ -n "$PRETTIER_FILES" ]; then
    echo "Running Prettier on staged files..."
    echo "$PRETTIER_FILES" | xargs pnpm exec prettier --write
    echo "$PRETTIER_FILES" | xargs git add
fi

echo "üëç Staged-file checks passed."
